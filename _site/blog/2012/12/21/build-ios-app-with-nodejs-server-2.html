<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>Levey write here</title>
  <meta name="author" content="Levey" />
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/skeleton.css">
  <link rel="stylesheet" href="/css/screen.css">
  <link rel="stylesheet" href="/css/layout.css">
  <link rel="stylesheet" href="/fonts/font-awesome.css">

</head>
<body>
  <div class="container">
    <div class="four columns sidebar">
      <nav>
        <h2>Levey</h2>
         <p> - </p>
        <ul>
        <p>iOS / Rails / Node Developer</p>
        <p>Reader</p>
        <p>Freelancer</p>
        <p>Gamer</p>        
        <p> - </p>
        
        <p style="margin-bottom: 10px;">
          Follow me:
          <div id="stalker">
            <a title="Levey on Github" target = "_blank" href="http://github.com/levey/"><i class="icon-github icon-large"></i></a>
            <a title="Levey on Twitter" target = "_blank" href="http://twitter.com/leveyzhu"><i class="icon-twitter icon-large"></i></a>
            <a title="RSS feed" target = "_blank" href="/atom.xml"><i class="icon-rss icon-large"></i></a>
          </div>
        </p>
        </ul>
      </nav>
    </div>

    <div class="eleven columns content">
      <p class="meta">
<a href="/"><i class="home icon-home"></i></a>
</p>
<h2 class="title">Objective-C / Node.js 编写 iOS app 前后端教程(二)</h2>

 <p class="signature"></p>
<div id="post">
<h4 id='id78'>说明</h4>

<p>这是一篇很基础的教程，全篇通过制作一个叫 WhateverNote 的 app，来描述 iOS app 的前端和服务端交互的。</p>

<p>这份教程只是用于初学示例，可能有很多不严谨的地方（比如有些类型检查遗漏了），请多多包含 :)</p>

<p>代码托管在 <a href='https://github.com/levey/WhateverNote'>GitHub</a>.</p>

<h4 id='__'>语言 / 框架</h4>

<p>iOS 端用到的语言就是 Objective-C, 为了方便我选择 <a href='https://github.com/AFNetworking/AFNetworking'>AFNetowrking</a> 作为 HTTP 库 。服务器端本来想用 Ruby on Rails 或者 Sinatra 的，但是后来想试一试 Node.js 的体验，所以就用 Node.js了，选择的 web framework 是 express.js, 跟 Sinatra 是类似的，都比较轻量级。</p>

<h4 id='id79'>工具</h4>

<p>iOS: <code>Xcode</code></p>

<p>Node.js: <code>Sublime Text 2</code> / <code> iTerm 2</code></p>
<hr />
<h4 id='whatevernote__ios'>WhateverNote - iOS</h4>

<h6 id='id80'>准备工作</h6>

<p>首先，使用 Xcode 新建一个名为 WhateverNote 的空项目。</p>

<p>预先在项目目录里预先新建 <strong>Controllers</strong>,<strong>Models</strong>, <strong>3rd-party</strong> 等目录。</p>

<p>然后从网上下载 <strong>AFNetworking</strong>, <strong>JSONKit</strong> 这2个第三方库到 3rd-party 目录下，然后引用进项目。</p>

<h5 id='_model'>实现 Model</h5>

<p>由于 WhateverNote 比较简单，就一个 model，而且属性也只有三个，所以 我们只要在 Model 目录下新建 <strong>Note.h</strong> 和 <strong>Note.m</strong>.代码如下：</p>

<p><strong>Note.h</strong></p>

<pre><code>@interface Note : NSObject

@property (nonatomic, strong) NSString *noteID;
@property (nonatomic, strong) NSString *title;
@property (nonatomic, strong) NSString *content;
@property (nonatomic, strong) NSString *author;

- (id)initWithAttributes:(NSDictionary *)attributes;

@end</code></pre>

<p><strong>Note.m</strong></p>

<pre><code>#import &quot;Note.h&quot;

@implementation Note

- (id)initWithAttributes:(NSDictionary *)attributes
{
	self = [super init];
	if (self) {
    	_noteID = [attributes valueForKeyPath:@&quot;_id&quot;];
    	_title = [attributes valueForKeyPath:@&quot;title&quot;];
    	_content = [attributes valueForKeyPath:@&quot;content&quot;];
    	_author = [attributes valueForKeyPath:@&quot;author&quot;];
	}

	return self;
}

@end</code></pre>

<p>接下来在 Note List 页面，我们会把从 server 端获取的 json 数据 解析成一个都是 Note 对象的列表。</p>

<h5 id='_controller'>实现 Controller</h5>

<p>在 Controller 目录下新建 <strong>NoteListViewController</strong> 和 <strong>NoteViewController</strong>.</p>

<p>NoteListViewController 继承自 UITableViewController, 功能是显示已存在 server 的 note 列表，能对列表的 cell 做删除，从而删除 server 上一个对应的 note. NoteViewConrller 功能是新增、查看、更新单个 Note 的信息 (通过回调给 NoteListViewController 执行)。</p>

<p>由于 API 是 RESTful 风格，我就直接使用了 AFNetworking 的 HTTPClient 类。</p>

<p>以下是网络请求的代码:</p>

<p><strong>NoteListViewController.m</strong></p>

<pre><code>-(void)refreshList
{    
	[self.httpClient getPath:@&quot;notes&quot; parameters:nil
	 success:^(AFHTTPRequestOperation *operation, id responseObject) {
    		NSArray *responseArray = [responseObject objectFromJSONData];
    		NSLog(@&quot;%@&quot;, responseArray);
    
    		NSMutableArray *mArr = [NSMutableArray array];
    		for (NSDictionary *attributes in responseArray) {
        		Note *note = [[Note alloc] initWithAttributes:attributes];
        		[mArr addObject:note];
    		}
    		self.dataArray = mArr;
    		[self.tableView reloadData];

		} failure:^(AFHTTPRequestOperation *operation, NSError *error) {
    			NSLog(@&quot;Failed to get note list, ERROR &gt;&gt; %@&quot;, error);
	}];
}

- (void)deleteNote:(Note *)aNote
{
	NSLog(@&quot;Delete a note with ID &gt;&gt; %@&quot;, aNote.noteID);
	[self.httpClient deletePath:[NSString stringWithFormat:@&quot;notes/%@&quot;,aNote.noteID] 
	parameters:nil 
	success:^(AFHTTPRequestOperation *operation, id responseObject) {
    		NSLog(@&quot;%@&quot;, [responseObject objectFromJSONData]);
    		NSDictionary *dict = [responseObject objectFromJSONData];
    		if ([dict[@&quot;success&quot;] integerValue] == 1) {
        		[self.dataArray removeObjectAtIndex:self.indexPathToBeDeleted.row];
        		[self.tableView deleteRowsAtIndexPaths:@[self.indexPathToBeDeleted]
        	withRowAnimation:UITableViewRowAnimationFade];
    		}
		} failure:^(AFHTTPRequestOperation *operation, NSError *error) {
    			NSLog(@&quot;Failed to delete a note, ERROR &gt;&gt; %@&quot;, error);
	}];
}



- (void)updateNote:(Note *)aNote
{
	NSDictionary *parameters = @{@&quot;title&quot;: aNote.title,
	 @&quot;content&quot;: aNote.content, 
	 @&quot;author&quot;: aNote.author};
	[self.httpClient putPath:[NSString stringWithFormat:@&quot;notes/%@&quot;,aNote.noteID]
	parameters:parameters 
	success:^(AFHTTPRequestOperation *operation, id responseObject) {
    		NSLog(@&quot;%@&quot;, [responseObject objectFromJSONData]);
    		NSDictionary *dict = [responseObject objectFromJSONData];
    		if ([dict[@&quot;success&quot;] integerValue] == 1) {
        		[self.navigationController popViewControllerAnimated:YES];
        		[self refreshList];
    		}

		} failure:^(AFHTTPRequestOperation *operation, NSError *error) {
    			NSLog(@&quot;Failed to update a note, ERROR &gt;&gt; %@&quot;, error);

	}];
}

- (void)createNote:(Note *)aNote
{
	NSDictionary *parameters = @{@&quot;title&quot;: aNote.title,
	 @&quot;content&quot;: aNote.content, 
	 @&quot;author&quot;: aNote.author};

	[self.httpClient postPath:@&quot;notes&quot; 
	parameters:parameters 
	success:^(AFHTTPRequestOperation *operation, id responseObject) {
    		NSLog(@&quot;%@&quot;, [responseObject objectFromJSONData]);
    		NSDictionary *dict = [responseObject objectFromJSONData];
    		if ([dict[@&quot;success&quot;] integerValue] == 1) {
        		[self.navigationController popViewControllerAnimated:YES];
        		[self refreshList];
    		}
		} failure:^(AFHTTPRequestOperation *operation, NSError *error) {
    			NSLog(@&quot;Failed to create a note, ERROR &gt;&gt; %@&quot;, error);
	}];
}</code></pre>

<p>iOS 端的具体逻辑也大致是这样了，整个教程就分 server 端 和 iOS 端 2个简洁的教程，具体看托管在 <a href='https://github.com/levey/WhateverNote'>GitHub</a> 上的代码。</p>

<p>实际项目往往复杂很多，引用居里夫人的话：</p>

<blockquote>
<p>Life is not easy for any of us.</p>
</blockquote>

<p>咖啡馆坐累了， 回家睡觉。</p>

 <p class="signature">2012-12-21  written by levey </p>
</div>

<div id="related">
  <h3>Related Posts</h3>
  <ul class="posts">
    
    <li><span>2012-12-20 &raquo;</span> <a href="/blog/2012/12/20/delegate-vs-blcok-vs-notification-vs-kvo.html">Delegate vs Blcok vs Notification vs KVO</a></li>
    
    <li><span>2012-12-13 &raquo;</span> <a href="/blog/2012/12/13/build-ios-app-with-nodejs-server-1.html">Objective-C / Node.js 编写 iOS app 前后端教程(一)</a></li>
    
    <li><span>2012-11-06 &raquo;</span> <a href="/blog/2012/11/06/migrate-postgresql-data-from-linode-to-heroku.html">从 Linode 导出 PostgreSQL 数据到 Heroku</a></li>
    
  </ul>
</div>
    
<!--       <div class="footer">
          <div class="disclaimer">
          <p>The postings on this site are my own and don't necessarily represent my 
          employer’s positions, strategies or opinions.</p>
        </div>
      </div> -->
    </div>
  </div>

<!-- <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-13005539-2']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script> -->

</body>
</html>
