<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>Levey writing</title>
  <meta name="author" content="Levey" />
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/skeleton.css">
  <link rel="stylesheet" href="/css/blog.css">
  <link rel="stylesheet" href="/css/layout.css">
  <link rel="stylesheet" href="/fonts/font-awesome.css">
  <link rel="stylesheet" href="/css/pygments.css">
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-41320932-1', 'golevey.com');
  ga('send', 'pageview');

  </script>
</head>
<body>
  <div class="container">

    <div class="fourteen columns content">
      <div roll="main" class="secondary">
<p class="meta">
<a href="/blog.html"><i class="home icon-home"></i></a>
</p>
<h2 class="title">Objective-C / Node.js 编写 iOS app 前后端教程-  iOS Client</h2>

 <p class="signature"></p>
<div id="post">
<h4>说明</h4>

<p>这是一篇很基础的教程，全篇通过制作一个叫 WhateverNote 的 app，来描述 iOS app 的前端和服务端交互的。</p>

<p>这份教程只是用于初学示例，可能有很多不严谨的地方（比如有些类型检查遗漏了），请多多包含 :)</p>

<p>代码托管在 <a href="https://github.com/levey/WhateverNote">GitHub</a>.</p>

<h4>语言 / 框架</h4>

<p>iOS 端用到的语言就是 Objective-C, 为了方便我选择 <a href="https://github.com/AFNetworking/AFNetworking">AFNetowrking</a> 作为 HTTP 库 。服务器端本来想用 Ruby on Rails  或者 Sinatra 的，但是后来想试一试 Node.js 的体验，所以就用 Node.js了，选择的 web framework 是 express.js, 跟 Sinatra 是类似的，都比较轻量级。</p>

<h4>工具</h4>

<p>iOS:  <code>Xcode</code></p>

<p>Node.js: <code>Sublime Text 2</code> / <code>iTerm 2</code></p>

<hr />

<h4>WhateverNote - iOS</h4>

<h6>准备工作</h6>

<p>首先，使用 Xcode 新建一个名为 WhateverNote 的空项目。</p>

<p>预先在项目目录里预先新建 <strong>Controllers</strong>,<strong>Models</strong>, <strong>3rd-party</strong> 等目录。</p>

<p>然后从网上下载 <strong>AFNetworking</strong>, <strong>JSONKit</strong> 这2个第三方库到 3rd-party 目录下，然后引用进项目。</p>

<h5>实现 Model</h5>

<p>由于 WhateverNote 比较简单，就一个 model，而且属性也只有三个，所以 我们只要在 Model 目录下新建 <strong>Note.h</strong> 和 <strong>Note.m</strong>.代码如下：</p>

<p><strong>Note.h</strong></p>

<div class="highlight"><pre><code class="objc"><span class="k">@interface</span> <span class="nc">Note</span> : <span class="nc">NSObject</span>

<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">noteID</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">title</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">content</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">author</span><span class="p">;</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">initWithAttributes:</span><span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nv">attributes</span><span class="p">;</span>

<span class="k">@end</span>
</code></pre></div>


<p><strong>Note.m</strong></p>

<div class="highlight"><pre><code class="objc"><span class="cp">#import &quot;Note.h&quot;</span>

<span class="k">@implementation</span> <span class="nc">Note</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">initWithAttributes:</span><span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nv">attributes</span>
<span class="p">{</span>
    <span class="n">self</span> <span class="o">=</span> <span class="p">[</span><span class="n">super</span> <span class="n">init</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_noteID</span> <span class="o">=</span> <span class="p">[</span><span class="n">attributes</span> <span class="n">valueForKeyPath</span><span class="o">:</span><span class="s">@&quot;_id&quot;</span><span class="p">];</span>
        <span class="n">_title</span> <span class="o">=</span> <span class="p">[</span><span class="n">attributes</span> <span class="n">valueForKeyPath</span><span class="o">:</span><span class="s">@&quot;title&quot;</span><span class="p">];</span>
        <span class="n">_content</span> <span class="o">=</span> <span class="p">[</span><span class="n">attributes</span> <span class="n">valueForKeyPath</span><span class="o">:</span><span class="s">@&quot;content&quot;</span><span class="p">];</span>
        <span class="n">_author</span> <span class="o">=</span> <span class="p">[</span><span class="n">attributes</span> <span class="n">valueForKeyPath</span><span class="o">:</span><span class="s">@&quot;author&quot;</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">@end</span>
</code></pre></div>


<p>接下来在 Note List 页面，我们会把从 server 端获取的 json 数据 解析成一个都是 Note 对象的列表。</p>

<h5>实现 Controller</h5>

<p>在 Controller 目录下新建 <strong>NoteListViewController</strong> 和 <strong>NoteViewController</strong>.</p>

<p>NoteListViewController 继承自 UITableViewController, 功能是显示已存在 server 的 note 列表，能对列表的 cell 做删除，从而删除 server 上一个对应的 note.
NoteViewConrller 功能是新增、查看、更新单个 Note 的信息 (通过回调给 NoteListViewController 执行)。</p>

<p>由于 API 是 RESTful 风格，我就直接使用了 AFNetworking 的 HTTPClient 类。</p>

<p>以下是网络请求的代码:</p>

<p><strong>NoteListViewController.m</strong></p>

<div class="highlight"><pre><code class="objc"><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">refreshList</span>
<span class="p">{</span>    
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">httpClient</span> <span class="n">getPath</span><span class="o">:</span><span class="s">@&quot;notes&quot;</span> <span class="n">parameters</span><span class="o">:</span><span class="nb">nil</span>
     <span class="nl">success:</span><span class="o">^</span><span class="p">(</span><span class="n">AFHTTPRequestOperation</span> <span class="o">*</span><span class="n">operation</span><span class="p">,</span> <span class="kt">id</span> <span class="n">responseObject</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">NSArray</span> <span class="o">*</span><span class="n">responseArray</span> <span class="o">=</span> <span class="p">[</span><span class="n">responseObject</span> <span class="n">objectFromJSONData</span><span class="p">];</span>
            <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span> <span class="n">responseArray</span><span class="p">);</span>
    
            <span class="n">NSMutableArray</span> <span class="o">*</span><span class="n">mArr</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSMutableArray</span> <span class="n">array</span><span class="p">];</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="n">attributes</span> <span class="k">in</span> <span class="n">responseArray</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">Note</span> <span class="o">*</span><span class="n">note</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Note</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">initWithAttributes</span><span class="o">:</span><span class="n">attributes</span><span class="p">];</span>
                <span class="p">[</span><span class="n">mArr</span> <span class="n">addObject</span><span class="o">:</span><span class="n">note</span><span class="p">];</span>
            <span class="p">}</span>
            <span class="n">self</span><span class="p">.</span><span class="n">dataArray</span> <span class="o">=</span> <span class="n">mArr</span><span class="p">;</span>
            <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">tableView</span> <span class="n">reloadData</span><span class="p">];</span>

        <span class="p">}</span> <span class="n">failure</span><span class="o">:^</span><span class="p">(</span><span class="n">AFHTTPRequestOperation</span> <span class="o">*</span><span class="n">operation</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Failed to get note list, ERROR &gt;&gt; %@&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
    <span class="p">}];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">deleteNote:</span><span class="p">(</span><span class="n">Note</span> <span class="o">*</span><span class="p">)</span><span class="nv">aNote</span>
<span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Delete a note with ID &gt;&gt; %@&quot;</span><span class="p">,</span> <span class="n">aNote</span><span class="p">.</span><span class="n">noteID</span><span class="p">);</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">httpClient</span> <span class="n">deletePath</span><span class="o">:</span><span class="p">[</span><span class="n">NSString</span> <span class="n">stringWithFormat</span><span class="o">:</span><span class="s">@&quot;notes/%@&quot;</span><span class="p">,</span><span class="n">aNote</span><span class="p">.</span><span class="n">noteID</span><span class="p">]</span> 
    <span class="n">parameters</span><span class="o">:</span><span class="nb">nil</span> 
    <span class="n">success</span><span class="o">:^</span><span class="p">(</span><span class="n">AFHTTPRequestOperation</span> <span class="o">*</span><span class="n">operation</span><span class="p">,</span> <span class="kt">id</span> <span class="n">responseObject</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">responseObject</span> <span class="n">objectFromJSONData</span><span class="p">]);</span>
            <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">dict</span> <span class="o">=</span> <span class="p">[</span><span class="n">responseObject</span> <span class="n">objectFromJSONData</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">([</span><span class="n">dict</span><span class="p">[</span><span class="s">@&quot;success&quot;</span><span class="p">]</span> <span class="n">integerValue</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">dataArray</span> <span class="n">removeObjectAtIndex</span><span class="o">:</span><span class="n">self</span><span class="p">.</span><span class="n">indexPathToBeDeleted</span><span class="p">.</span><span class="n">row</span><span class="p">];</span>
                <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">tableView</span> <span class="n">deleteRowsAtIndexPaths</span><span class="o">:</span><span class="err">@</span><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">indexPathToBeDeleted</span><span class="p">]</span>
            <span class="nl">withRowAnimation:</span><span class="n">UITableViewRowAnimationFade</span><span class="p">];</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="n">failure</span><span class="o">:^</span><span class="p">(</span><span class="n">AFHTTPRequestOperation</span> <span class="o">*</span><span class="n">operation</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Failed to delete a note, ERROR &gt;&gt; %@&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
    <span class="p">}];</span>
<span class="p">}</span>



<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">updateNote:</span><span class="p">(</span><span class="n">Note</span> <span class="o">*</span><span class="p">)</span><span class="nv">aNote</span>
<span class="p">{</span>
    <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">parameters</span> <span class="o">=</span> <span class="err">@</span><span class="p">{</span><span class="s">@&quot;title&quot;</span><span class="o">:</span> <span class="n">aNote</span><span class="p">.</span><span class="n">title</span><span class="p">,</span>
     <span class="s">@&quot;content&quot;</span><span class="o">:</span> <span class="n">aNote</span><span class="p">.</span><span class="n">content</span><span class="p">,</span> 
     <span class="s">@&quot;author&quot;</span><span class="o">:</span> <span class="n">aNote</span><span class="p">.</span><span class="n">author</span><span class="p">};</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">httpClient</span> <span class="n">putPath</span><span class="o">:</span><span class="p">[</span><span class="n">NSString</span> <span class="n">stringWithFormat</span><span class="o">:</span><span class="s">@&quot;notes/%@&quot;</span><span class="p">,</span><span class="n">aNote</span><span class="p">.</span><span class="n">noteID</span><span class="p">]</span>
    <span class="nl">parameters:</span><span class="n">parameters</span> 
    <span class="n">success</span><span class="o">:^</span><span class="p">(</span><span class="n">AFHTTPRequestOperation</span> <span class="o">*</span><span class="n">operation</span><span class="p">,</span> <span class="kt">id</span> <span class="n">responseObject</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">responseObject</span> <span class="n">objectFromJSONData</span><span class="p">]);</span>
            <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">dict</span> <span class="o">=</span> <span class="p">[</span><span class="n">responseObject</span> <span class="n">objectFromJSONData</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">([</span><span class="n">dict</span><span class="p">[</span><span class="s">@&quot;success&quot;</span><span class="p">]</span> <span class="n">integerValue</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">navigationController</span> <span class="n">popViewControllerAnimated</span><span class="o">:</span><span class="nb">YES</span><span class="p">];</span>
                <span class="p">[</span><span class="n">self</span> <span class="n">refreshList</span><span class="p">];</span>
            <span class="p">}</span>

        <span class="p">}</span> <span class="n">failure</span><span class="o">:^</span><span class="p">(</span><span class="n">AFHTTPRequestOperation</span> <span class="o">*</span><span class="n">operation</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Failed to update a note, ERROR &gt;&gt; %@&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>

    <span class="p">}];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">createNote:</span><span class="p">(</span><span class="n">Note</span> <span class="o">*</span><span class="p">)</span><span class="nv">aNote</span>
<span class="p">{</span>
    <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">parameters</span> <span class="o">=</span> <span class="err">@</span><span class="p">{</span><span class="s">@&quot;title&quot;</span><span class="o">:</span> <span class="n">aNote</span><span class="p">.</span><span class="n">title</span><span class="p">,</span>
     <span class="s">@&quot;content&quot;</span><span class="o">:</span> <span class="n">aNote</span><span class="p">.</span><span class="n">content</span><span class="p">,</span> 
     <span class="s">@&quot;author&quot;</span><span class="o">:</span> <span class="n">aNote</span><span class="p">.</span><span class="n">author</span><span class="p">};</span>

    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">httpClient</span> <span class="n">postPath</span><span class="o">:</span><span class="s">@&quot;notes&quot;</span> <span class="n">parameters</span><span class="o">:</span><span class="n">parameters</span> 
    <span class="n">success</span><span class="o">:^</span><span class="p">(</span><span class="n">AFHTTPRequestOperation</span> <span class="o">*</span><span class="n">operation</span><span class="p">,</span> <span class="kt">id</span> <span class="n">responseObject</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">responseObject</span> <span class="n">objectFromJSONData</span><span class="p">]);</span>
            <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">dict</span> <span class="o">=</span> <span class="p">[</span><span class="n">responseObject</span> <span class="n">objectFromJSONData</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">([</span><span class="n">dict</span><span class="p">[</span><span class="s">@&quot;success&quot;</span><span class="p">]</span> <span class="n">integerValue</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">navigationController</span> <span class="n">popViewControllerAnimated</span><span class="o">:</span><span class="nb">YES</span><span class="p">];</span>
                <span class="p">[</span><span class="n">self</span> <span class="n">refreshList</span><span class="p">];</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="n">failure</span><span class="o">:^</span><span class="p">(</span><span class="n">AFHTTPRequestOperation</span> <span class="o">*</span><span class="n">operation</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Failed to create a note, ERROR &gt;&gt; %@&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
    <span class="p">}];</span>
<span class="p">}</span>
</code></pre></div>


<p>iOS 端的具体逻辑也大致是这样了，整个教程就分 server 端 和 iOS 端 2个简洁的教程，具体看托管在 <a href="https://github.com/levey/WhateverNote">GitHub</a> 上的代码。</p>

<p>实际项目往往复杂很多，引用居里夫人的话：</p>

<blockquote><p>Life is not easy for any of us.</p></blockquote>

<p>咖啡馆坐累了， 回家睡觉。</p>


 <p class="signature">2012-12-21  written by levey </p>
</div>

<!-- <div id="related">
  <h3>Related Posts</h3>
  <ul class="posts">
    
    <li><span>2012-12-20 &raquo;</span> <a href="/blog/2012/12/20/delegate-vs-blcok-vs-notification-vs-kvo.html">Delegate vs Blcok vs Notification vs KVO</a></li>
    
    <li><span>2012-12-13 &raquo;</span> <a href="/blog/2012/12/13/build-ios-app-with-nodejs-server-1.html">Objective-C / Node.js 编写 iOS app 前后端教程 - Node.js Server</a></li>
    
    <li><span>2012-11-06 &raquo;</span> <a href="/blog/2012/11/06/migrate-postgresql-data-from-linode-to-heroku.html">从 Linode 导出 PostgreSQL 数据到 Heroku</a></li>
    
  </ul>
</div>

</div> -->
    
    </div>
  </div>
</body>
</html>
