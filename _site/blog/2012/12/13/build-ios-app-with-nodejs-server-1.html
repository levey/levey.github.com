<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>Levey write here</title>
  <meta name="author" content="Levey" />
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/skeleton.css">
  <link rel="stylesheet" href="/css/screen.css">
  <link rel="stylesheet" href="/css/layout.css">
  <link rel="stylesheet" href="/fonts/font-awesome.css">
  <link rel="stylesheet" href="/css/pygments.css">
</head>
<body>
  <div class="container">

    <div class="fourteen columns content">
      <div roll="main" class="secondary">
<p class="meta">
<a href="/blog.html"><i class="home icon-home"></i></a>
</p>
<h2 class="title">Objective-C / Node.js 编写 iOS app 前后端教程 - Node.js Server</h2>

 <p class="signature"></p>
<div id="post">
<h4>说明</h4>

<p>这是一篇很基础的教程，全篇通过制作一个叫 WhateverNote 的 app，来描述 iOS app 的前端和服务端交互的。</p>

<p>这份教程只是用于初学示例，可能有很多不严谨的地方（比如有些类型检查遗漏了），请多多包含 :)</p>

<p>代码托管在 <a href="https://github.com/levey/WhateverNote">GitHub</a>.</p>

<h4>语言 / 框架</h4>

<p>iOS 端用到的语言就是 Objective-C, 为了方便我选择 <a href="https://github.com/AFNetworking/AFNetworking">AFNetowrking</a> 作为 HTTP 库 。服务器端本来想用 Ruby on Rails  或者 Sinatra 的，但是后来想试一试 Node.js 的体验，所以就用 Node.js了，选择的 web framework 是 express.js, 跟 Sinatra 是类似的，都比较轻量级。</p>

<h4>工具</h4>

<p>iOS:  <code>Xcode</code></p>

<p>Node.js: <code>Sublime Text 2</code> / <code>iTerm 2</code></p>

<hr />

<h4>WhateverNote - Server</h4>

<p>先从 <a href="http://nodejs.org">http://nodejs.org</a> 下载安装 Node.js，我当前的最新稳定版本为 v0.8.15。</p>

<p>安装 Node.js 成功后，通过终端安装 express.js, -g 参数表示安装的包为全局的。</p>

<pre><code>npm install -g express
</code></pre>

<p>安装 express.js 成功后， 在 WhateverNote 目录下新建一个 Whatever-server 的项目</p>

<pre><code>express Whatever-server
</code></pre>

<p>进入刚建立的项目的目录 执行</p>

<pre><code>node app.js 
</code></pre>

<p>然后用浏览器打开 localhost:3000 就能看到 express 的欢迎页面了。</p>

<p>然后我们看一下 app.js 这个文件，</p>

<pre><code>var express = require('express')
 , routes = require('./routes')
 , user = require('./routes/user')
 , http = require('http')
 , path = require('path');

var app = express();
</code></pre>

<p>这些是一些变量，express 是以文件目录的形式来定义类型的。</p>

<pre><code>app.configure(function(){
  app.set('port', process.env.PORT || 3000);
  app.set('views', __dirname + '/views');
  app.set('view engine', 'jade');
  app.use(express.favicon());
  app.use(express.logger('dev'));
  app.use(express.bodyParser());
  app.use(express.methodOverride());
  app.use(app.router);
  app.use(express.static(path.join(__dirname, 'public')));
});
</code></pre>

<p>这些是对 express 的配置。</p>

<p>接下来</p>

<pre><code>app.get('/', routes.index);
</code></pre>

<p>这一行就是对刚才访问到的主页的处理。</p>

<p>最后</p>

<pre><code>http.createServer(app).listen(app.get('port'), function(){
  console.log("Express server listening on port " + app.get('port'));
});
</code></pre>

<p>就是服务器的创建，因为 Node.js 运行环境本身可以作为 web server，所以不用 apache/nginx 等类似的 web server.</p>

<p>我们的程序结构用 MVC + Routes，类似 Ruby on Rails, 但是我们只是需要的是 iOS 端获得 JSON 数据，所以我们可以去掉 View 这一层（删掉 views 目录）。</p>

<p>然后新建 models 和 conterllers 目录，分别在刚建的目录里新建 note.js 文件。</p>

<p>我喜欢用单个文件来做 URL 路由， 所以删除了 routes 目录，新建 routes.js 代替。</p>

<p>在 <strong>controllers/note.js</strong> 写上如下代码</p>

<pre><code>exports.index = function (req, res) {
  res.send('hello world');
};
</code></pre>

<p>然后在 <strong>routes.js</strong> 写下如下代码</p>

<pre><code>var note = require('./controllers/note')

exports.route = function (app) {
  app.get('/', function(req, res) {
    res.send('hello world');
  });
};
</code></pre>

<p>最后在 <strong>app.js</strong> 中 把那些 express 的默认建立的 user 变量删除，然后用以下代码替换原来的路由代码。</p>

<pre><code>routes.route(app);
// app.get('/', routes.index);
</code></pre>

<p>然后重新启动 Server (node app.js)，我们就可以看到主页只输出 hello world 字符串。</p>

<h5>创建Model</h5>

<p>mongoose 这个库管理 MongoDB 听方便的，在 <strong>/models/note.js</strong> 里写下如下代码</p>

<pre><code>var mongoose = require('mongoose');
var db = mongoose.createConnection('mongodb://localhost/notes')
var NoteSchema = mongoose.Schema({
  title: String,
  content: String,
  author: String
});

exports.Note = db.model('Note',NoteSchema);
</code></pre>

<p>然后我们在 <strong>/controllers/note.js</strong> 里用一句</p>

<pre><code>var Note = require('../models/note').Note;
</code></pre>

<p>来引入 Note 这个 model，之后在这个 controller 里就能新建 Note 对象了。</p>

<h5>创建路由</h5>

<p>在 <strong>routes.js</strong> 里追加如下 API</p>

<pre><code>var note = require('./controllers/note')

exports.route = function (app) {
  app.get('/', function(req, res) {
    res.send('hello world');
  });
  app.get('/notes', note.index);
  app.get('/notes/:id', note.show);
  app.post('/notes', note.create);
  app.put('/notes/:id',note.update);
  app.delete('/notes/:id', note.destroy);
};
</code></pre>

<p>第一个就是获取 note 列表。</p>

<p>第二个是得到一个 note 的详细信息（不过咱这个 demo 直接一个列表就有了详细信息）。</p>

<p>第三个是新建一个 note.</p>

<p>第四个是删除一个对应 id 的 note.</p>

<h5>最后一步，完善 Controller</h5>

<p>在之前一步我们看到了 每个 API 都调用了 controller 里的相应方法, 打开 <strong>./controllers/note</strong> 输入如下代码</p>

<p>var Note = require('../models/note').Note;</p>

<pre><code>exports.index = function(req, res) {
  Note.find(function(err, notes) {
    if (!err) {
        res.send(notes);
    } else {
        res.send(err);
    }
  });
}

exports.show = function(req, res) {
  Note.findById(req.params.id, function (err, note) {
    if (!err) {
      res.send({success: 1, note: note});
    } else {
      res.send({success: 0});
    }
  });
}

exports.create = function(req, res) {
  var note = new Note();
  note.title = req.body.title;
  note.content = req.body.content;
  note.author = req.body.author;
  console.log(note);
  note.save(function(err){
    if (!err) {
        res.send({success: 1});
    } else {
        res.send({success: 0});
    }
  });
}

exports.update = function(req, res) {
  var update = {
    title: req.param('title'), 
    content: req.param('content'), 
    author: req.param('author')
  };
  Note.findByIdAndUpdate(req.params.id, update, function(err) {
    if (err) {
      res.send(err);
    } else {
      res.send({success: 1});
    }
  });
}

exports.destroy = function(req, res) {
  if (!req.params.id) {
    res.send({success: 0, error: "Need &lt;id&gt; parameter."});
  } else {
    Note.findById(req.params.id, function (err, note) {
      if (!err) {
        if (note) {
          note.remove(function(err) {
            if (!err) {
                res.send({success: 1});
            } else {
                res.send({success: 0, error: "Failed to delete."});
            }
          });
        } else {
            res.send({success: 0, error: "Can not find note."});
        }
      } else {
        res.send({success: 0, error: "Failed to delete."});
      }
    });
  }
}
</code></pre>

<h5>测试</h5>

<p>由于我们使用了 MongoDB 作为数据库，我们需要先安装，使用 Homebrew 安装很方便，终端执行</p>

<pre><code>brew update
brew install mongodb
</code></pre>

<p>安装好后，在终端执行 <strong>mongod</strong> 就可以开启数据库服务了。</p>

<p>然后，我们先在终端执行 <strong>node app.js</strong> 开启应用服务器。</p>

<p>最后，可以写个脚本试一下创建一个 note, Ruby 代码如下</p>

<pre><code>require 'net/http'
response = Net::HTTP.post_form(URI.parse('http://localhost:3000/notes'), 
                           {title: 'hello world',
                            content: 'hello big world',
                            author: 'levey'})

puts response.body
</code></pre>

<p>如果输出 { "success": 1 } ， 说明创建成功。</p>

<h5>歇会儿 &amp; 接下来</h5>

<p>至此，WhateverNote 的 Server 端的这几个 API 完成了，接下来的第二篇将是 iOS 客户端与刚写好的 Server 端的交互的教程。</p>

<p><strong>Have a nice day.</strong></p>


 <p class="signature">2012-12-13  written by levey </p>
</div>

<div id="related">
  <h3>Related Posts</h3>
  <ul class="posts">
    
    <li><span>2012-12-21 &raquo;</span> <a href="/blog/2012/12/21/build-ios-app-with-nodejs-server-2.html">Objective-C / Node.js 编写 iOS app 前后端教程-  iOS Client</a></li>
    
    <li><span>2012-12-20 &raquo;</span> <a href="/blog/2012/12/20/delegate-vs-blcok-vs-notification-vs-kvo.html">Delegate vs Blcok vs Notification vs KVO</a></li>
    
    <li><span>2012-11-06 &raquo;</span> <a href="/blog/2012/11/06/migrate-postgresql-data-from-linode-to-heroku.html">从 Linode 导出 PostgreSQL 数据到 Heroku</a></li>
    
  </ul>
</div>

</div>
    
    </div>
  </div>
</body>
</html>
